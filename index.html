<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI to Lua Converter</title>
</head>
<body>
    <h1>MIDI to Lua Converter</h1>
    <input type="file" id="midiFile" accept=".midi, .mid">
    <input type="text" id="bpmInput" placeholder="Enter BPM" value="120">
    <button id="convertBtn">Convert</button>
    <h2>Output:</h2>
    <pre id="output"></pre>

    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
    <script>
        const noteMappings = {
            "C": {1: "C1", 2: "C2", 3: "C3", 4: "C4", 5: "C5"},
            "C#": {1: "C#1", 2: "C#2", 3: "C#3", 4: "C#4", 5: "C#5"},
            "D": {1: "D1", 2: "D2", 3: "D3", 4: "D4", 5: "D5"},
            "D#": {1: "D#1", 2: "D#2", 3: "D#3", 4: "D#4", 5: "D#5"},
            "E": {1: "E1", 2: "E2", 3: "E3", 4: "E4", 5: "E5"},
            "F": {1: "F1", 2: "F2", 3: "F3", 4: "F4", 5: "F5"},
            "F#": {1: "F#1", 2: "F#2", 3: "F#3", 4: "F#4", 5: "F#5"},
            "G": {1: "G1", 2: "G2", 3: "G3", 4: "G4", 5: "G5"},
            "G#": {1: "G#1", 2: "G#2", 3: "G#3", 4: "G#4", 5: "G#5"},
            "A": {1: "A1", 2: "A2", 3: "A3", 4: "A4", 5: "A5"},
            "A#": {1: "A#1", 2: "A#2", 3: "A#3", 4: "A#4", 5: "A#5"},
            "B": {1: "B1", 2: "B2", 3: "B3", 4: "B4", 5: "B5"}
        };

        function convertMidiToLua(midiData, bpm) {
            const outputLines = [];
            const tracks = midiData.tracks;

            let mergedNotes = [];
            
            // Iterate through each track
            tracks.forEach(track => {
                // Filter out drum tracks (MIDI track type 10)
                if (!track.notes || track.type === 'drum') return;

                // Merge notes from this track
                mergedNotes = mergedNotes.concat(track.notes);
            });

            // Sort notes by their time
            mergedNotes.sort((a, b) => a.time - b.time);

            let lastTime = 0;

            mergedNotes.forEach((note, index) => {
                const noteName = note.name;
                const octave = note.octave;
                const duration = note.duration;
                
                // Ignore notes outside of C1 to C5
                if (octave < 1 || octave > 5) return;

                // Calculate rest time
                const restTime = note.time - lastTime;

                // If there is a rest, add it to output
                if (restTime > 0) {
                    const restDuration = restTime / (bpm / 60);  // Convert to seconds
                    outputLines.push(`rest(${restDuration.toFixed(2)}, ${bpm})`);
                }

                // Add the note to output
                const noteDuration = duration / (bpm / 60); // Convert to seconds
                outputLines.push(`pressnote("${noteName}", ${octave}, ${noteDuration.toFixed(2)}, ${bpm})`);

                // Update the last time
                lastTime = note.time + duration; // Time for next note (includes its duration)
            });

            return outputLines.join('\n');
        }

        document.getElementById('convertBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('midiFile');
            const bpmInput = document.getElementById('bpmInput');
            const outputElement = document.getElementById('output');

            if (fileInput.files.length === 0) {
                alert('Please select a MIDI file.');
                return;
            }

            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const midi = new Midi(arrayBuffer);

            const bpm = parseInt(bpmInput.value) || 120; // Default BPM to 120 if not provided
            const luaOutput = convertMidiToLua(midi, bpm);
            outputElement.textContent = luaOutput;
        });
    </script>
</body>
</html>
