<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI to Lua Converter</title>
</head>
<body>
    <h1>MIDI to Lua Converter</h1>
    <input type="file" id="midiFile" accept=".mid" />
    <label for="bpm">Enter BPM:</label>
    <input type="number" id="bpm" placeholder="120" min="30" max="300" />
    <button id="convertButton">Convert</button>
    <pre id="output"></pre>

    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
    <script>
        const noteMappings = {
            // Add your note mappings here
            'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11,
        };

        function convertMidiToLua(midiData, bpm) {
            const midi = new Midi(midiData);
            const outputLines = [];
            let currentTrackNotes = [];

            // Function to process and merge notes
            function processTrack(track) {
                const notes = track.notes.filter(note => note.midi >= 24 && note.midi <= 72); // C1 (MIDI 24) to C5 (MIDI 72)
                if (notes.length > 0) {
                    currentTrackNotes.push(...notes);
                }
            }

            // Process each track
            midi.tracks.forEach(track => {
                if (!track.name.toLowerCase().includes('drum')) {  // Ignore drum tracks
                    processTrack(track);
                } else {
                    // Handle drum tracks separately if needed, or ignore them
                }
            });

            // Generate output lines for notes
            currentTrackNotes.forEach(note => {
                const octave = Math.floor(note.midi / 12) - 1; // Convert MIDI number to octave
                const noteName = Object.keys(noteMappings).find(key => noteMappings[key] === (note.midi % 12));
                const beats = note.duration / midi.header.tempos[0].bpm; // Adjust beat calculation as necessary
                outputLines.push(`pressnote("${noteName}", ${octave}, ${beats.toFixed(2)}, ${bpm})`);
            });

            return outputLines.join('\n');
        }

        document.getElementById('convertButton').addEventListener('click', async () => {
            const fileInput = document.getElementById('midiFile');
            const bpmInput = document.getElementById('bpm');
            const output = document.getElementById('output');

            if (!fileInput.files.length) {
                output.textContent = 'Please upload a MIDI file.';
                return;
            }

            const midiFile = fileInput.files[0];
            const bpm = bpmInput.value || 120; // Default to 120 BPM if not specified
            const midiData = await midiFile.arrayBuffer();

            const luaCode = convertMidiToLua(midiData, bpm);
            output.textContent = luaCode;
        });
    </script>
</body>
</html>
